<!doctype html><html lang=en-us><head><meta name=generator content="Hugo 0.85.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=hugo-theme content="Axiom 0.8.0"><link rel=icon type=image/png sizes=32x32 href=https://dpolyakov.github.io/openlumi.github.io/><link rel=icon type=image/x-icon href=https://dpolyakov.github.io/openlumi.github.io/><link rel=apple-touch-icon href=https://dpolyakov.github.io/openlumi.github.io/><link rel=canonical href=https://dpolyakov.github.io/openlumi.github.io/ru/><link rel=alternate type=application/rss+xml href=https://dpolyakov.github.io/openlumi.github.io/ru/index.xml hreflang=en-us><link rel=preload as=style href="https://dpolyakov.github.io/openlumi.github.io/openlumi.github.io/bundle.css?v=1631896713" media=all><link rel=stylesheet href="https://dpolyakov.github.io/openlumi.github.io/openlumi.github.io/bundle.css?v=1631896713" media=all><style>.cdata pre{background-color:#1f2937;color:#e5e7eb}.cdata :not(pre)>code{background-color:#f3f4f6;color:#7c3aed}.chroma .err{background-color:#991b1b;color:#fecaca}.chroma .hl{background-color:#374151}.chroma .ln{color:#9ca3af}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#60a5fa}.chroma .kt{color:#a78bfa}.chroma .na,.chroma .nb{color:#fbbf24}.chroma .nc{color:#f87171}.chroma .no{color:#34d399}.chroma .nd{color:#f87171}.chroma .ne{color:#f87171}.chroma .nf{color:#fbbf24}.chroma .nt{color:#f87171}.chroma .l{color:#a78bfa}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#34d399}.chroma .se{color:#9ca3af}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#34d399}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#a78bfa}.chroma .o,.chroma .ow{color:#93c5fd}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs,.chroma .p{color:#9ca3af}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style><title>Установка альтернативной прошивки OpenWrt на шлюзы DGNWG05LM и ZHWG11LM : OpenWrt на шлюзах DGNWG05LM и ZHWG11LM</title><meta property="og:title" content="Установка альтернативной прошивки OpenWrt на шлюзы DGNWG05LM и ZHWG11LM"><meta property="og:site_name" content="OpenWrt на шлюзах DGNWG05LM и ZHWG11LM"><meta property="og:url" content="https://dpolyakov.github.io/openlumi.github.io/ru/"><link rel=image_src href=https://dpolyakov.github.io/><meta property="og:image" content="https://dpolyakov.github.io/"><meta property="og:image:width" content><meta property="og:image:height" content><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:description" content=":toc: Инструкция относится только к европейской версии шлюза от xiaomi mieu01, с европейской вилкой, а также к версии шлюза от Aqara ZHWG11LM с китайской или европейской вилкой. Для версии xiaomi gateway2 с китайской вилкой DGNWG02LM она не подойдёт, в нём установлены другие аппаратные комплектующие."><meta name=description content=":toc: Инструкция относится только к европейской версии шлюза от xiaomi mieu01, с европейской вилкой, а также к версии шлюза от Aqara ZHWG11LM с китайской или европейской вилкой. Для версии xiaomi gateway2 с китайской вилкой DGNWG02LM она не подойдёт, в нём установлены другие аппаратные комплектующие."><meta property="og:updated_time" content="0001-01-01T00:00:00Z"><meta property="fb:app_id" content><meta name=author content="Unknown"><meta property="article:author" content="https://dpolyakov.github.io/openlumi.github.io"><meta property="article:published_time" content="0001-01-01T00:00:00Z"><meta property="article:modified_time" content="0001-01-01T00:00:00Z"><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","headline":"Установка альтернативной прошивки OpenWrt на шлюзы DGNWG05LM и ZHWG11LM","alternativeHeadline":":toc: Инструкция относится только к европейской версии шлюза от xiaomi mieu01, с европейской вилкой, а также к версии шлюза от Aqara ZHWG11LM с китайской или европейской вилкой. Для версии xiaomi gateway2 с китайской вилкой DGNWG02LM она не подойдёт, в нём установлены другие аппаратные комплектующие.","url":"https://dpolyakov.github.io/openlumi.github.io/ru/","image":"https://dpolyakov.github.io/","mainEntityOfPage":{"@type":"WebPage","@id":"https://dpolyakov.github.io/openlumi.github.io/ru/"},"description":":toc: Инструкция относится только к европейской версии шлюза от xiaomi mieu01, с европейской вилкой, а также к версии шлюза от Aqara ZHWG11LM с китайской или европейской вилкой. Для версии xiaomi gateway2 с китайской вилкой DGNWG02LM она не подойдёт, в нём установлены другие аппаратные комплектующие.","author":{"@type":"Person","name":"Unknown"},"publisher":{"@type":"Organization","name":"OpenWrt на шлюзах DGNWG05LM и ZHWG11LM","logo":{"@type":"ImageObject","url":"https://dpolyakov.github.io/"}},"datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","articleBody":"\u003cp\u003e:toc:\u003c/p\u003e\n\u003cp\u003eИнструкция относится только к европейской версии шлюза от xiaomi mieu01,\nс европейской вилкой, а также к версии шлюза от Aqara ZHWG11LM с китайской или\nевропейской вилкой. Для версии xiaomi gateway2 с китайской вилкой\nDGNWG02LM она не подойдёт, в нём установлены другие аппаратные комплектующие.\u003c/p\u003e\n\u003cp\u003eДанная инструкция подразумевает, что у вас уже есть доступ ssh к шлюзу.\nЕсли вы это не сделали, воспользуйтесь инструкцией\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://4pda.ru/forum/index.php?act=findpost\u0026amp;pid=99314437\u0026amp;anchor=Spoil-99314437-1\"\u003ehttps://4pda.ru/forum/index.php?act=findpost\u0026amp;pid=99314437\u0026amp;anchor=Spoil-99314437-1\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"резервная-копия\"\u003eРезервная копия\u003c/h2\u003e\n\u003cp\u003eСделайте резервную копию. Если вы решите вернуться на\nоригинальную прошивку, для восстановления вам потребуется tar.gz с архивом\nкорневой файловой системы.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003etar -cvpzf /tmp/lumi_stock.tar.gz -C / . --exclude\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;./tmp/*\u0026#39;\u003c/span\u003e --exclude\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;./proc/*\u0026#39;\u003c/span\u003e --exclude\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;./sys/*\u0026#39;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eПосле того, как бэкап сделается, скачайте его на локальный компьютер\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003escp root@*GATEWAY_IP*:/tmp/lumi_stock.tar.gz .\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eили с помощью программы WinScp в режиме \u003ccode\u003escp\u003c/code\u003e (dropbear на шлюзе не поддерживает режим sftp)\u003c/p\u003e\n\u003cp\u003eЕсли у вас уже есть образ rootfs сделанный через dd, \u003cstrong\u003eвсё равно сделайте архив\u003c/strong\u003e.\nНа этапе загрузки образа dd обычно возникают ошибки nand flash или ubifs. Вариант\nс tar.gz лишён этих недостатков, потому что форматирует флеш перед загрузкой.\u003c/p\u003e\n\u003ch2 id=\"прошивка-по-воздуху\"\u003eПрошивка по воздуху\u003c/h2\u003e\n\u003cp\u003eЭто наиболее простой метод, который можно использовать даже через ssh.\nОн не требует дополнительной пайки но работает только на оригинальной\nоперационной системе.\u003c/p\u003e\n\u003cp\u003eУбедитесь, что у вас нет лишних архивов во временной папке /tmp, потребуется место\nдля скачивания архивов. Также, шлюз должен быть подключён к интернету.\u003c/p\u003e\n\u003cp\u003eЗапустите команду:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003eecho -e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;GET /openlumi/owrt-installer/main/install.sh HTTP/1.0\\nHost: raw.githubusercontent.com\\n\u0026#34;\u003c/span\u003e | openssl s_client -quiet -connect raw.githubusercontent.com:443 2\u0026gt;/dev/null | sed \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;1,/^\\r$/d\u0026#39;\u003c/span\u003e | bash\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eДанная команда завершит все процессы на шлюзе (если у вас оборвётся) сеанс ssh,\nэто ожидаемое поведение. Прошивка занимает несколько минут. По окончанию прошивки,\nшлюз поднимет открытую сеть OpenWrt. Если это произошло, можно сразу переходить\nк разделу \u003ca href=\"#%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-openwrt\"\u003e\u0026ldquo;Использование OpenWrt\u0026rdquo;\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eРепозиторий скриптов для установки \u003ca href=\"https://github.com/openlumi/owrt-installer\"\u003ehttps://github.com/openlumi/owrt-installer\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"если-по-каким-то-причинам-у-вас-не-сработал-метод-прошивки-по-воздуху-вы-почти-всегда-можете-вернуть-к-жизни-шлюз-припаяв-usb-и-uart-и-прошить-через-mfgtools\"\u003eЕсли по каким-то причинам, у вас не сработал метод прошивки по воздуху, вы почти всегда можете вернуть к жизни шлюз припаяв usb и uart и прошить через mfgtools\u003c/h2\u003e\n\u003ch2 id=\"припаяйте-usb--uart\"\u003eПрипаяйте usb + uart\u003c/h2\u003e\n\u003cp\u003eЧтобы провести модификацию прошивки вам потребуется произвести\nаппаратные модификации, припаять 7 проводов к самому шлюзу\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e3 провода на usb2uart переходник (вы это делали на этапе получения рута)\u003c/li\u003e\n\u003cli\u003e4 провода на usb разъём или провод с usb штекером на конце.\nДостаточно припаять 4 провода, +5v, d+, d- и gnd.\nID провод не задействуется\nПроверьте, что d+ и d- не перепутаны местами, иначе устройство не определится\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"images/gateway_pinout.jpg\" alt=\"Распиновка UART и USB на шлюзе\" title=\"Как припаивать провода\"\u003e\u003c/p\u003e\n\u003ch2 id=\"прошивка\"\u003eПрошивка\u003c/h2\u003e\n\u003cp\u003eМы подготовили архив с программой mfgtools для загрузки прощивки на шлюз,\nа также саму прошивку. В архив включена программа для windows\nи консольное приложение под linux\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"files/mfgtools-19.07.5-20201217.zip\"\u003eВерсия 19.07.5 2020-12-17\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"подключите-шлюз-к-компьютеру\"\u003eПодключите шлюз к компьютеру\u003c/h3\u003e\n\u003cp\u003eНужно подключить шлюз двумя кабелями к компьютеру. UART и USB.\nUSB на данном этапе не будет определяться в компьютере.\nЧтобы подключиться к консоли шлюза, для windows используйте\nпрограмму PuTTY и используйте COM-порт, который появился для usb2uart.\nДля linux используйте любую терминальную программу, например\n\u003ccode\u003epicocom /dev/ttyUSB0 -b 115200\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"перевод-в-режим-загрузки-через-usb\"\u003eПеревод в режим загрузки через USB\u003c/h3\u003e\n\u003cp\u003eДля того чтобы перевести в режим прошивки, нужно при старте шлюза в\nконсоли на последовательном порту прервать загрузку uboot нажатием\nлюбой кнопки. У вас будет 1 секунда на это. Появится приглашение для команд\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e=\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eДалее в командной строке uboot вам надо ввести\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ebmode usb\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eИ нажать enter.\nПосле этого шлюз перейдёт в режим загрузки по usb и mfgtools сможет обновить\nразделы в памяти шлюза.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"images/bmode_usb.png\" alt=\"Переход в режим загрузки по USB\" title=\"Переход в режим загрузки по USB\"\u003e\u003c/p\u003e\n\u003cp\u003eВ случае если у вас Windows, вам может потребоваться установить драйвера,\nиз папки Drivers.\u003c/p\u003e\n\u003cp\u003eЗапускайте mfgtools.\u003c/p\u003e\n\u003ch4 id=\"windows\"\u003eWindows\u003c/h4\u003e\n\u003cp\u003eВ случае windows, у вас откроется окно. Если всё припаяно правильно и драйвера\nустановлены верно, то в строке в программе будет написано\nHID-compliant device\n\u003cimg src=\"images/mfgtools_win.png\" alt=\"Mfgtools\" title=\"Mfgtools\"\u003e\u003c/p\u003e\n\u003cp\u003eНужно нажать кнопку Start для начала прошивки.\u003c/p\u003e\n\u003cp\u003eПосле окончания прошивки, когда полоска прогресса дойдёт до конца и\nстанет зелёной, нужно нажать Stop. Если этого не сделать, спустя несколько\nминут программа начнёт прошивку повторно, и это приведёт к ошибке. Если такое\nслучилось, перезагрузите шлюз и повторите процедуру, начиная перевода\nшлюза в \u003ccode\u003ebmode usb\u003c/code\u003e.\u003c/p\u003e\n\u003ch4 id=\"linux\"\u003eLinux\u003c/h4\u003e\n\u003cp\u003eПерейдите в папку с прошивкой. Запустите консольную утилиту от суперпользователя\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003esudo ./mfgtoolcli -p \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eВ псевдографическом интерфейсе будут отображаться этапы прошивки\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"images/mfgtools_lin.png\" alt=\"Mfgtools\"\u003e\u003c/p\u003e\n\u003cp\u003eПри подключении шлюза и обнаружении hid устройства, программа сразу начнёт\nпроцесс прошивки. Если процесс не пошёл, проверьте, что устройство подключено и\nопределилось в выводе команды \u003ccode\u003edmesg\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"процесс-прошивки\"\u003eПроцесс прошивки\u003c/h3\u003e\n\u003cp\u003eСледить за этапами прошивки можно также и в консоли вывода самого шлюза.\nПо окончанию прошивки в консоли будет выведено\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eUpdate Complete!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"images/update_complete.png\" alt=\"Update complete\"\u003e\u003c/p\u003e\n\u003cp\u003eПосле этого можно перезагружать шлюз. Вытащите его из розетки и воткните обратно.\nИногда, шлюз виснет на финальном этапе. Если в течение 5 минут ничего не происходит,\nто скорее всего прошивка прошла удачно и можно перезагрузить шлюз.\u003c/p\u003e\n\u003ch1 id=\"не-забудьте-подключить-антенны\"\u003eНе забудьте подключить антенны!\u003c/h1\u003e\n\u003cp\u003eИначе проблемы с подключением к сети обеспечены\u003c/p\u003e\n\u003ch3 id=\"использование-openwrt\"\u003eИспользование OpenWrt\u003c/h3\u003e\n\u003cp\u003eПосле прошивки шлюз поднимает открытую wifi сеть с именем OpenWrt.\nЧтобы подключить его уже к своему роутеру, вам нужно подключиться к\nэтой сети и зайти на адрес http://192.168.1.1/\u003c/p\u003e\n\u003cp\u003eПо умолчанию вход на шлюз: логин root без пароля.\u003c/p\u003e\n\u003cp\u003eПерейдите в раздел Network -\u0026gt; Wireless\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"images/owrt_menu.png\" alt=\"Go to Wireless\"\u003e\u003c/p\u003e\n\u003cp\u003eНажмите кнопку Scan напротив первого интерфейса radio0\nЧерез несколько секунд вы сможете увидеть список сетей. Найдите вашу сеть\nи нажмите Join Network\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"images/owrt_scan.png\" alt=\"Scan\"\u003e\u003c/p\u003e\n\u003cp\u003eВ появившемся окне отметьте галочку \u0026ldquo;Replace wireless configuration\u0026rdquo;.\nНиже укажите пароль от вашей сети\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"images/owrt_connect1.png\" alt=\"WiFi password\"\u003e\u003c/p\u003e\n\u003cp\u003eНа следующем экране подтвердите параметры, нажмите кнопку Save.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"images/owrt_connect2.png\" alt=\"WiFi password-2\"\u003e\u003c/p\u003e\n\u003cp\u003eЧтобы правильно применить изменения, нужно отключить точку доступа нажав кнопку\n\u0026ldquo;Disable\u0026rdquo; напротив подключения для второго интерфейса.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"images/owrt_disable_ap.png\" alt=\"Disable AP\"\u003e\u003c/p\u003e\n\u003cp\u003eШлюз отключит вас от точки доступа и применит изменения сети.\nПосле прошивки меняется mac адрес шлюза, потому ip адрес тоже скорее всего\nпоменяется. Проверьте его в роутере или в самом шлюзе.\u003c/p\u003e\n\u003cp\u003eНа шлюзе предустановлены:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eГрафический интерфейс OpenWrt LuCi на 80 порту http\u003c/li\u003e\n\u003cli\u003eкомандная утилита для прошивки zigbee модуля jn5169\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eНе включайте на шлюзе одновременно режимы WiFi AP + Station.\nДрайвер, который используется в системе не может работать в двух режимах\nодновременно.\nЕсли вы поменяли настройки LuCi и после этого шлюз перестал подключаться к сети,\nзажмите кнопку на шлюзе на 10 секунд. Он промигает жёлтым цветом 3 раза и\nперейдёт в режим начальной настройки сети, подняв точку доступа AP\u003c/p\u003e\n\u003ch3 id=\"работа-с-zigbee\"\u003eРабота с Zigbee\u003c/h3\u003e\n\u003cp\u003eМодуль Zigbee может работать только с одной из систем, потому вам нужно выбрать,\nкакую из программ вы будете использовать. В то же время, можно использовать,\nнапример zigbee2mqtt для работы с zigbee и domoticz для других автоматизаций.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"/ru/zigbee2mqtt/\"\u003eУстановка Zigbee2mqtt\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/ru/zesp32/\"\u003eУстановка Zesp32\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/ru/domoticz-zigate/\"\u003eУстановка Domoticz и настройка плагина zigate\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"сброс-на-заводские-настройки\"\u003eСброс на заводские настройки\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eБудьте аккуратны со сбросом настроек, все программы и настройки будут стёрты.\nИспользуйте его в крайнем случае, когда сброс сети и дальнейшая настройка не помогает.\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eЕсть 2 способа сбросить все данные на прошивке OpenWrt и вернуться на этап начальной\nустановки (как будто вы только что прошили шлюз)\u003c/p\u003e\n\u003ch4 id=\"с-помощью-кнопки\"\u003eС помощью кнопки\u003c/h4\u003e\n\u003cp\u003eЗажмите кнопку на 20 секунд.\nШлюз промигает красным 3 раза и вернётся к начальной настройке с поднятием точки доступа.\u003c/p\u003e\n\u003ch4 id=\"при-помощи-uart\"\u003eПри помощи UART\u003c/h4\u003e\n\u003cp\u003eПодключите шлюз к компьютеру через UART и дождитесь загрузки системы.\u003c/p\u003e\n\u003cp\u003eВыполните команду\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003efirstboot -y \u0026amp;\u0026amp; reboot now\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"возврат-на-стоковую-прошивку\"\u003eВозврат на стоковую прошивку\u003c/h3\u003e\n\u003cp\u003eДля возврата на родную прошивку нужно прошить оригинальные ядро, dtb и\nфайловую систему из резервной копии. Ядро и dtb одинаковые на все прошивки,\nа для работы оригинального приложения xiaomi вам потребуется бекап.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"files/mfgtools-lumi-stock.zip\"\u003emfgtools для возврата на сток\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eПоложите свой бекап с именем \u003ccode\u003elumi_stock.tar.gz\u003c/code\u003e в папку \u003ccode\u003eProfiles/Linux/OS Firmware/files\u003c/code\u003e\nповерх пустого файла \u003ccode\u003elumi_stock.tar.gz\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eДальше переведите шлюз в режим загрузки по usb и через mfgtools прошейте\nоригинальную прошивку.\u003c/p\u003e\n\u003ch2 id=\"gpiohahahugoshortcode-s3-hbhb\"\u003e\u003ca href=\"/ru/gpio/\"\u003egpio\u003c/a\u003e\u003c/h2\u003e\n\u003ch2 id=\"ссылки\"\u003eСсылки\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eСтатья, которая подробно описывает изменения технические модификации:\n\u003ca href=\"https://habr.com/ru/post/494296/\"\u003eXiaomi Gateway (eu version — Lumi.gateway.mieu01 ) Hacked\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eСборник информации по аппаратному и програмному модингу Xiaomi Gateway \u003ca href=\"https://github.com/T-REX-XP/XiaomiGatewayHack\"\u003ehttps://github.com/T-REX-XP/XiaomiGatewayHack\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eТелеграм канал с обсуждением модификаций \u003ca href=\"https://t.me/xiaomi_gw_hack\"\u003ehttps://t.me/xiaomi_gw_hack\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e"}</script><link rel=preload as=script href="https://dpolyakov.github.io/openlumi.github.io/bundle.js?v=1631896713"></head><body><header id=nav class=header><div class="ax-l-i max-w-6xl"><div class=ax-logo><a class=block href=https://dpolyakov.github.io/openlumi.github.io/ru/ title="OpenWrt на шлюзах DGNWG05LM и ZHWG11LM"><span class="font-semibold text-raven-900">OpenWrt на шлюзах DGNWG05LM и ZHWG11LM</span></a></div><div class=ax-user><a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target=_blank rel="noopener nofollow" href="https://www.google.com/search?q=site:https://dpolyakov.github.io/openlumi.github.io/" title=Поиск><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33.0 002.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg></a></div></div></header><main><div class=page-single><div class="ax-content ax-l-o"><div class="ax-l-i max-w-680"><h1 class="page-title font-content-title font-normal leading-tight tracking-default text-40">Установка альтернативной прошивки OpenWrt на шлюзы DGNWG05LM и ZHWG11LM</h1><article class="cdata mt-8"><p>:toc:</p><p>Инструкция относится только к европейской версии шлюза от xiaomi mieu01,
с европейской вилкой, а также к версии шлюза от Aqara ZHWG11LM с китайской или
европейской вилкой. Для версии xiaomi gateway2 с китайской вилкой
DGNWG02LM она не подойдёт, в нём установлены другие аппаратные комплектующие.</p><p>Данная инструкция подразумевает, что у вас уже есть доступ ssh к шлюзу.
Если вы это не сделали, воспользуйтесь инструкцией</p><p><a href="https://4pda.ru/forum/index.php?act=findpost&pid=99314437&anchor=Spoil-99314437-1">https://4pda.ru/forum/index.php?act=findpost&pid=99314437&anchor=Spoil-99314437-1</a></p><h2 id=резервная-копия>Резервная копия</h2><p>Сделайте резервную копию. Если вы решите вернуться на
оригинальную прошивку, для восстановления вам потребуется tar.gz с архивом
корневой файловой системы.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tar -cvpzf /tmp/lumi_stock.tar.gz -C / . --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;./tmp/*&#39;</span> --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;./proc/*&#39;</span> --exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;./sys/*&#39;</span>
</code></pre></div><p>После того, как бэкап сделается, скачайте его на локальный компьютер</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>scp root@*GATEWAY_IP*:/tmp/lumi_stock.tar.gz .
</code></pre></div><p>или с помощью программы WinScp в режиме <code>scp</code> (dropbear на шлюзе не поддерживает режим sftp)</p><p>Если у вас уже есть образ rootfs сделанный через dd, <strong>всё равно сделайте архив</strong>.
На этапе загрузки образа dd обычно возникают ошибки nand flash или ubifs. Вариант
с tar.gz лишён этих недостатков, потому что форматирует флеш перед загрузкой.</p><h2 id=прошивка-по-воздуху>Прошивка по воздуху</h2><p>Это наиболее простой метод, который можно использовать даже через ssh.
Он не требует дополнительной пайки но работает только на оригинальной
операционной системе.</p><p>Убедитесь, что у вас нет лишних архивов во временной папке /tmp, потребуется место
для скачивания архивов. Также, шлюз должен быть подключён к интернету.</p><p>Запустите команду:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>echo -e <span style=color:#e6db74>&#34;GET /openlumi/owrt-installer/main/install.sh HTTP/1.0\nHost: raw.githubusercontent.com\n&#34;</span> | openssl s_client -quiet -connect raw.githubusercontent.com:443 2&gt;/dev/null | sed <span style=color:#e6db74>&#39;1,/^\r$/d&#39;</span> | bash
</code></pre></div><p>Данная команда завершит все процессы на шлюзе (если у вас оборвётся) сеанс ssh,
это ожидаемое поведение. Прошивка занимает несколько минут. По окончанию прошивки,
шлюз поднимет открытую сеть OpenWrt. Если это произошло, можно сразу переходить
к разделу <a href=#%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-openwrt>&ldquo;Использование OpenWrt&rdquo;</a></p><p>Репозиторий скриптов для установки <a href=https://github.com/openlumi/owrt-installer>https://github.com/openlumi/owrt-installer</a></p><h2 id=если-по-каким-то-причинам-у-вас-не-сработал-метод-прошивки-по-воздуху-вы-почти-всегда-можете-вернуть-к-жизни-шлюз-припаяв-usb-и-uart-и-прошить-через-mfgtools>Если по каким-то причинам, у вас не сработал метод прошивки по воздуху, вы почти всегда можете вернуть к жизни шлюз припаяв usb и uart и прошить через mfgtools</h2><h2 id=припаяйте-usb--uart>Припаяйте usb + uart</h2><p>Чтобы провести модификацию прошивки вам потребуется произвести
аппаратные модификации, припаять 7 проводов к самому шлюзу</p><ul><li>3 провода на usb2uart переходник (вы это делали на этапе получения рута)</li><li>4 провода на usb разъём или провод с usb штекером на конце.
Достаточно припаять 4 провода, +5v, d+, d- и gnd.
ID провод не задействуется
Проверьте, что d+ и d- не перепутаны местами, иначе устройство не определится</li></ul><p><img src=images/gateway_pinout.jpg alt="Распиновка UART и USB на шлюзе" title="Как припаивать провода"></p><h2 id=прошивка>Прошивка</h2><p>Мы подготовили архив с программой mfgtools для загрузки прощивки на шлюз,
а также саму прошивку. В архив включена программа для windows
и консольное приложение под linux</p><p><a href=files/mfgtools-19.07.5-20201217.zip>Версия 19.07.5 2020-12-17</a></p><h3 id=подключите-шлюз-к-компьютеру>Подключите шлюз к компьютеру</h3><p>Нужно подключить шлюз двумя кабелями к компьютеру. UART и USB.
USB на данном этапе не будет определяться в компьютере.
Чтобы подключиться к консоли шлюза, для windows используйте
программу PuTTY и используйте COM-порт, который появился для usb2uart.
Для linux используйте любую терминальную программу, например
<code>picocom /dev/ttyUSB0 -b 115200</code></p><h3 id=перевод-в-режим-загрузки-через-usb>Перевод в режим загрузки через USB</h3><p>Для того чтобы перевести в режим прошивки, нужно при старте шлюза в
консоли на последовательном порту прервать загрузку uboot нажатием
любой кнопки. У вас будет 1 секунда на это. Появится приглашение для команд</p><pre><code>=&gt;
</code></pre><p>Далее в командной строке uboot вам надо ввести</p><pre><code>bmode usb
</code></pre><p>И нажать enter.
После этого шлюз перейдёт в режим загрузки по usb и mfgtools сможет обновить
разделы в памяти шлюза.</p><p><img src=images/bmode_usb.png alt="Переход в режим загрузки по USB" title="Переход в режим загрузки по USB"></p><p>В случае если у вас Windows, вам может потребоваться установить драйвера,
из папки Drivers.</p><p>Запускайте mfgtools.</p><h4 id=windows>Windows</h4><p>В случае windows, у вас откроется окно. Если всё припаяно правильно и драйвера
установлены верно, то в строке в программе будет написано
HID-compliant device
<img src=images/mfgtools_win.png alt=Mfgtools title=Mfgtools></p><p>Нужно нажать кнопку Start для начала прошивки.</p><p>После окончания прошивки, когда полоска прогресса дойдёт до конца и
станет зелёной, нужно нажать Stop. Если этого не сделать, спустя несколько
минут программа начнёт прошивку повторно, и это приведёт к ошибке. Если такое
случилось, перезагрузите шлюз и повторите процедуру, начиная перевода
шлюза в <code>bmode usb</code>.</p><h4 id=linux>Linux</h4><p>Перейдите в папку с прошивкой. Запустите консольную утилиту от суперпользователя</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo ./mfgtoolcli -p <span style=color:#ae81ff>1</span>
</code></pre></div><p>В псевдографическом интерфейсе будут отображаться этапы прошивки</p><p><img src=images/mfgtools_lin.png alt=Mfgtools></p><p>При подключении шлюза и обнаружении hid устройства, программа сразу начнёт
процесс прошивки. Если процесс не пошёл, проверьте, что устройство подключено и
определилось в выводе команды <code>dmesg</code></p><h3 id=процесс-прошивки>Процесс прошивки</h3><p>Следить за этапами прошивки можно также и в консоли вывода самого шлюза.
По окончанию прошивки в консоли будет выведено</p><pre><code>Update Complete!
</code></pre><p><img src=images/update_complete.png alt="Update complete"></p><p>После этого можно перезагружать шлюз. Вытащите его из розетки и воткните обратно.
Иногда, шлюз виснет на финальном этапе. Если в течение 5 минут ничего не происходит,
то скорее всего прошивка прошла удачно и можно перезагрузить шлюз.</p><h1 id=не-забудьте-подключить-антенны>Не забудьте подключить антенны!</h1><p>Иначе проблемы с подключением к сети обеспечены</p><h3 id=использование-openwrt>Использование OpenWrt</h3><p>После прошивки шлюз поднимает открытую wifi сеть с именем OpenWrt.
Чтобы подключить его уже к своему роутеру, вам нужно подключиться к
этой сети и зайти на адрес http://192.168.1.1/</p><p>По умолчанию вход на шлюз: логин root без пароля.</p><p>Перейдите в раздел Network -> Wireless</p><p><img src=images/owrt_menu.png alt="Go to Wireless"></p><p>Нажмите кнопку Scan напротив первого интерфейса radio0
Через несколько секунд вы сможете увидеть список сетей. Найдите вашу сеть
и нажмите Join Network</p><p><img src=images/owrt_scan.png alt=Scan></p><p>В появившемся окне отметьте галочку &ldquo;Replace wireless configuration&rdquo;.
Ниже укажите пароль от вашей сети</p><p><img src=images/owrt_connect1.png alt="WiFi password"></p><p>На следующем экране подтвердите параметры, нажмите кнопку Save.</p><p><img src=images/owrt_connect2.png alt="WiFi password-2"></p><p>Чтобы правильно применить изменения, нужно отключить точку доступа нажав кнопку
&ldquo;Disable&rdquo; напротив подключения для второго интерфейса.</p><p><img src=images/owrt_disable_ap.png alt="Disable AP"></p><p>Шлюз отключит вас от точки доступа и применит изменения сети.
После прошивки меняется mac адрес шлюза, потому ip адрес тоже скорее всего
поменяется. Проверьте его в роутере или в самом шлюзе.</p><p>На шлюзе предустановлены:</p><ul><li>Графический интерфейс OpenWrt LuCi на 80 порту http</li><li>командная утилита для прошивки zigbee модуля jn5169</li></ul><p>Не включайте на шлюзе одновременно режимы WiFi AP + Station.
Драйвер, который используется в системе не может работать в двух режимах
одновременно.
Если вы поменяли настройки LuCi и после этого шлюз перестал подключаться к сети,
зажмите кнопку на шлюзе на 10 секунд. Он промигает жёлтым цветом 3 раза и
перейдёт в режим начальной настройки сети, подняв точку доступа AP</p><h3 id=работа-с-zigbee>Работа с Zigbee</h3><p>Модуль Zigbee может работать только с одной из систем, потому вам нужно выбрать,
какую из программ вы будете использовать. В то же время, можно использовать,
например zigbee2mqtt для работы с zigbee и domoticz для других автоматизаций.</p><ol><li><a href=https://dpolyakov.github.io/openlumi.github.io/ru/zigbee2mqtt/>Установка Zigbee2mqtt</a></li><li><a href=https://dpolyakov.github.io/openlumi.github.io/ru/zesp32/>Установка Zesp32</a></li><li><a href=https://dpolyakov.github.io/openlumi.github.io/ru/domoticz-zigate/>Установка Domoticz и настройка плагина zigate</a></li></ol><h3 id=сброс-на-заводские-настройки>Сброс на заводские настройки</h3><p><strong>Будьте аккуратны со сбросом настроек, все программы и настройки будут стёрты.
Используйте его в крайнем случае, когда сброс сети и дальнейшая настройка не помогает.</strong></p><p>Есть 2 способа сбросить все данные на прошивке OpenWrt и вернуться на этап начальной
установки (как будто вы только что прошили шлюз)</p><h4 id=с-помощью-кнопки>С помощью кнопки</h4><p>Зажмите кнопку на 20 секунд.
Шлюз промигает красным 3 раза и вернётся к начальной настройке с поднятием точки доступа.</p><h4 id=при-помощи-uart>При помощи UART</h4><p>Подключите шлюз к компьютеру через UART и дождитесь загрузки системы.</p><p>Выполните команду</p><pre><code>firstboot -y &amp;&amp; reboot now
</code></pre><h3 id=возврат-на-стоковую-прошивку>Возврат на стоковую прошивку</h3><p>Для возврата на родную прошивку нужно прошить оригинальные ядро, dtb и
файловую систему из резервной копии. Ядро и dtb одинаковые на все прошивки,
а для работы оригинального приложения xiaomi вам потребуется бекап.</p><p><a href=files/mfgtools-lumi-stock.zip>mfgtools для возврата на сток</a></p><p>Положите свой бекап с именем <code>lumi_stock.tar.gz</code> в папку <code>Profiles/Linux/OS Firmware/files</code>
поверх пустого файла <code>lumi_stock.tar.gz</code></p><p>Дальше переведите шлюз в режим загрузки по usb и через mfgtools прошейте
оригинальную прошивку.</p><h2 id=gpiohahahugoshortcode-s3-hbhb><a href=https://dpolyakov.github.io/openlumi.github.io/ru/gpio/>gpio</a></h2><h2 id=ссылки>Ссылки</h2><ol><li>Статья, которая подробно описывает изменения технические модификации:
<a href=https://habr.com/ru/post/494296/>Xiaomi Gateway (eu version — Lumi.gateway.mieu01 ) Hacked</a></li><li>Сборник информации по аппаратному и програмному модингу Xiaomi Gateway <a href=https://github.com/T-REX-XP/XiaomiGatewayHack>https://github.com/T-REX-XP/XiaomiGatewayHack</a></li><li>Телеграм канал с обсуждением модификаций <a href=https://t.me/xiaomi_gw_hack>https://t.me/xiaomi_gw_hack</a></li></ol></article></div></div></div></main><footer class=footer><div class="ax-l-i max-w-6xl"><nav class="flex items-center justify-center"></nav><div class="footer-copyright text-sm text-center text-gray-400 mt-4">&#169; -2021 OpenWrt на шлюзах DGNWG05LM и ZHWG11LM</div><div class="text-sm sm:text-xs text-center text-gray-400 mt-2">Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a></div></div></footer><script src="https://dpolyakov.github.io/openlumi.github.io/openlumi.github.io/bundle.js?v=1631896713"></script></body></html>